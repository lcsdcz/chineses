<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•é¡µé¢ - å¤è¯—æ–‡é»˜å†™ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>é«˜ä¸­è¯­æ–‡æ—©è¯»åŠ©æ‰‹</h1>
            <p>å¤è¯—æ–‡èƒŒè¯µé»˜å†™ç³»ç»Ÿ - æµ‹è¯•é¡µé¢</p>
        </header>

        <!-- æ¨¡å¼é€‰æ‹©é¡µé¢ -->
        <div class="mode-selection" id="mode-selection">
            <h2>é€‰æ‹©å­¦ä¹ æ¨¡å¼</h2>
            <div class="mode-cards">
                <div class="mode-card" onclick="setMode('recitation')">
                    <h3>é»˜å†™æ¨¡å¼</h3>
                    <p>é€‚åˆè‡ªæˆ‘æ£€æµ‹å’Œç»ƒä¹ </p>
                    <span class="mode-icon">âœï¸</span>
                </div>
                <div class="mode-card" onclick="setMode('memorization')">
                    <h3>èƒŒè¯µæ¨¡å¼</h3>
                    <p>é€‚åˆå¤ä¹ å·©å›ºå’Œè®°å¿†</p>
                    <span class="mode-icon">ğŸ“š</span>
                </div>
            </div>
        </div>

        <!-- ç« èŠ‚é€‰æ‹©é¡µé¢ -->
        <div class="chapter-selection" id="chapterSelection" style="display: none;">
            <h2>é€‰æ‹©å­¦ä¹ ç« èŠ‚</h2>
            <div class="chapter-cards">
                <div class="chapter-card" onclick="selectChapter('å¿…ä¿®ä¸€')">
                    <h3>å¿…ä¿®ä¸€</h3>
                    <p>è¯—ç»ã€æ¥šè¾ç­‰å…ˆç§¦æ–‡å­¦</p>
                    <span class="chapter-icon">ğŸ“–</span>
                </div>
                <div class="chapter-card" onclick="selectChapter('å¿…ä¿®äºŒ')">
                    <h3>å¿…ä¿®äºŒ</h3>
                    <p>å”è¯—ç­‰å¤å…¸è¯—è¯</p>
                    <span class="chapter-icon">ğŸŒ¸</span>
                </div>
                <div class="chapter-card" onclick="selectChapter('å¿…ä¿®ä¸‰')">
                    <h3>å¿…ä¿®ä¸‰</h3>
                    <p>å®‹è¯ç­‰å¤å…¸è¯—è¯</p>
                    <span class="chapter-icon">ğŸ</span>
                </div>
                <div class="chapter-card" onclick="selectChapter('è®ºè¯­å¿…èƒŒ')">
                    <h3>è®ºè¯­å¿…èƒŒ</h3>
                    <p>ç»å…¸åå¥ã€äººç”Ÿå“²ç†</p>
                    <span class="chapter-icon">ğŸ›ï¸</span>
                </div>
            </div>
        </div>

        <!-- è¯—æ–‡é€‰æ‹©é¡µé¢ -->
        <div class="poem-selection" id="poemSelection" style="display: none;">
            <h2>é€‰æ‹©è¯—æ–‡ - <span id="currentChapter">å¿…ä¿®ä¸€</span></h2>
            <div class="poem-list" id="poemList">
                <!-- è¯—æ–‡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é»˜å†™é¡µé¢ -->
        <div class="recitation-page" id="recitationPage" style="display: none;">
            <h2 id="poemTitle">å…³é› - é»˜å†™ç»ƒä¹ </h2>
            <div class="poem-content">
                <div class="poem-text" id="poemText">
                    <!-- è¯—æ–‡å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="recitation-area">
                <h3>è¯·é»˜å†™ä»¥ä¸‹å†…å®¹ï¼š</h3>
                <div class="blank-text" id="blankText">
                    <!-- å¸¦ç©ºç™½çš„è¯—æ–‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="input-area">
                    <textarea id="studentAnswer" placeholder="è¯·åœ¨æ­¤è¾“å…¥ä½ çš„é»˜å†™å†…å®¹...&#10;&#10;å¡«å‰å¥/å¡«åå¥æ¨¡å¼ï¼šè¯·æŒ‰é¢˜ç›®é¡ºåºè¾“å…¥ç­”æ¡ˆï¼Œç”¨é€—å·åˆ†éš”&#10;ä¾‹å¦‚ï¼šå…³å…³é›é¸ ,çªˆçª•æ·‘å¥³,å‚å·®è‡èœ&#10;&#10;è‡ªåŠ¨æ¨¡å¼ï¼šè¯·ç›´æ¥è¾“å…¥è¿ç»­çš„å­—ç¬¦"></textarea>
                    <div class="action-buttons">
                        <button class="submit-btn" onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
                        <button class="show-answer-btn" onclick="showAnswer()" style="display: none;">æ˜¾ç¤ºåŸæ–‡</button>
                        <button class="next-btn" onclick="nextPoem()" style="display: none;">ä¸‹ä¸€ç¯‡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="poems-data.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentMode = '';
        let currentChapter = '';
        let currentPoemIndex = 0;
        let poems = [];
        let currentExerciseType = 'auto';
        let currentExerciseIndex = 0;
        let currentExerciseConfig = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½å®Œæˆï¼');
            console.log('æ•°æ®åº“åŒ…å«ç« èŠ‚ï¼š', Object.keys(window.poemDatabase || {}));
        });

        // è®¾ç½®å­¦ä¹ æ¨¡å¼
        function setMode(mode) {
            console.log('è®¾ç½®æ¨¡å¼ï¼š', mode);
            currentMode = mode;
            document.getElementById('mode-selection').style.display = 'none';
            document.getElementById('chapterSelection').style.display = 'block';
        }

        // é€‰æ‹©ç« èŠ‚
        function selectChapter(chapter) {
            console.log('é€‰æ‹©ç« èŠ‚ï¼š', chapter);
            currentChapter = chapter;
            
            // ä¼˜å…ˆä½¿ç”¨å¤–éƒ¨æ•°æ®
            if (typeof window.poemDatabase !== 'undefined' && window.poemDatabase[chapter]) {
                poems = window.poemDatabase[chapter];
            } else {
                // ä½¿ç”¨æµ‹è¯•æ•°æ®
                poems = getTestPoems(chapter);
            }
            
            document.getElementById('chapterSelection').style.display = 'none';
            document.getElementById('poemSelection').style.display = 'block';
            document.getElementById('currentChapter').textContent = chapter;
            displayPoemList();
        }

        // è·å–æµ‹è¯•æ•°æ®
        function getTestPoems(chapter) {
            const testData = {
                'å¿…ä¿®ä¸€': [
                    {
                        title: 'å…³é›',
                        author: 'ã€Šè¯—ç»ã€‹',
                        content: 'å…³å…³é›é¸ ï¼Œåœ¨æ²³ä¹‹æ´²ã€‚çªˆçª•æ·‘å¥³ï¼Œå›å­å¥½é€‘ã€‚å‚å·®è‡èœï¼Œå·¦å³æµä¹‹ã€‚çªˆçª•æ·‘å¥³ï¼Œå¯¤å¯æ±‚ä¹‹ã€‚æ±‚ä¹‹ä¸å¾—ï¼Œå¯¤å¯æ€æœã€‚æ‚ å“‰æ‚ å“‰ï¼Œè¾—è½¬åä¾§ã€‚å‚å·®è‡èœï¼Œå·¦å³é‡‡ä¹‹ã€‚çªˆçª•æ·‘å¥³ï¼Œç´ç‘Ÿå‹ä¹‹ã€‚å‚å·®è‡èœï¼Œå·¦å³èŠ¼ä¹‹ã€‚çªˆçª•æ·‘å¥³ï¼Œé’Ÿé¼“ä¹ä¹‹ã€‚',
                        exercises: [
                            {
                                type: 'fillBack',
                                title: 'ç»å…¸åå¥å¡«ç©º',
                                description: 'è¯·æ ¹æ®å‰åŠå¥å†…å®¹ï¼Œå¡«å†™ååŠå¥',
                                items: [
                                    { front: 'å…³å…³é›é¸ ', back: 'åœ¨æ²³ä¹‹æ´²', hint: 'é¸Ÿå„¿åœ¨å“ªé‡Œï¼Ÿ' },
                                    { front: 'çªˆçª•æ·‘å¥³', back: 'å›å­å¥½é€‘', hint: 'ä»€ä¹ˆæ ·çš„å¥³å­ï¼Ÿ' },
                                    { front: 'å‚å·®è‡èœ', back: 'å·¦å³æµä¹‹', hint: 'æ°´è‰å¦‚ä½•ï¼Ÿ' },
                                    { front: 'çªˆçª•æ·‘å¥³', back: 'å¯¤å¯æ±‚ä¹‹', hint: 'æ—¥å¤œæ€å¿µ' }
                                ]
                            },
                            {
                                type: 'auto',
                                title: 'é‡ç‚¹å­—è¯é»˜å†™',
                                description: 'è¯·å¡«å†™ä¸‹åˆ’çº¿å¤„çš„å­—è¯',
                                blanks: [3, 7, 11, 15, 19, 23, 27, 31, 35, 39],
                                hints: ['é¸Ÿå«å£°', 'å¥³å­', 'æ°´è‰', 'æ€å¿µ', 'è¾—è½¬', 'é‡‡æ‘˜', 'ä¹å™¨', 'é€‰æ‹©', 'ä¹å™¨', 'æ¬¢ä¹']
                            }
                        ]
                    },
                    {
                        title: 'è’¹è‘­',
                        author: 'ã€Šè¯—ç»ã€‹',
                        content: 'è’¹è‘­è‹è‹ï¼Œç™½éœ²ä¸ºéœœã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¸€æ–¹ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”é•¿ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å¤®ã€‚è’¹è‘­è‹è‹ï¼Œç™½éœ²æœªæ™ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¹„ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”è·»ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å»ã€‚è’¹è‘­é‡‡é‡‡ï¼Œç™½éœ²æœªå·²ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¶˜ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”å³ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­æ²šã€‚',
                        exercises: [
                            {
                                type: 'fillBack',
                                title: 'æ„å¢ƒç†è§£å¡«ç©º',
                                description: 'è¯·æ ¹æ®å‰åŠå¥å†…å®¹ï¼Œå¡«å†™ååŠå¥',
                                items: [
                                    { front: 'è’¹è‘­è‹è‹', back: 'ç™½éœ²ä¸ºéœœ', hint: 'ç§‹å¤©çš„æ™¯è±¡' },
                                    { front: 'æ‰€è°“ä¼Šäºº', back: 'åœ¨æ°´ä¸€æ–¹', hint: 'æ€å¿µçš„äººåœ¨å“ªé‡Œï¼Ÿ' },
                                    { front: 'æº¯æ´„ä»ä¹‹', back: 'é“é˜»ä¸”é•¿', hint: 'é€†æµè€Œä¸Š' }
                                ]
                            }
                        ]
                    }
                ],
                'å¿…ä¿®äºŒ': [
                    {
                        title: 'é™å¤œæ€',
                        author: 'æç™½',
                        content: 'åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚ä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡ã€‚',
                        exercises: [
                            {
                                type: 'fillBack',
                                title: 'æ€ä¹¡æƒ…æ€€å¡«ç©º',
                                description: 'è¯·æ ¹æ®å‰åŠå¥å†…å®¹ï¼Œå¡«å†™ååŠå¥',
                                items: [
                                    { front: 'åºŠå‰æ˜æœˆå…‰', back: 'ç–‘æ˜¯åœ°ä¸Šéœœ', hint: 'æœˆå…‰åƒä»€ä¹ˆï¼Ÿ' },
                                    { front: 'ä¸¾å¤´æœ›æ˜æœˆ', back: 'ä½å¤´æ€æ•…ä¹¡', hint: 'æŠ¬å¤´çœ‹ä»€ä¹ˆï¼Ÿ' }
                                ]
                            }
                        ]
                    }
                ],
                'å¿…ä¿®ä¸‰': [
                    {
                        title: 'èœ€ç›¸',
                        author: 'æœç”«',
                        content: 'ä¸ç›¸ç¥ å ‚ä½•å¤„å¯»ï¼Œé”¦å®˜åŸå¤–æŸæ£®æ£®ã€‚æ˜ é˜¶ç¢§è‰è‡ªæ˜¥è‰²ï¼Œéš”å¶é»„é¹‚ç©ºå¥½éŸ³ã€‚ä¸‰é¡¾é¢‘çƒ¦å¤©ä¸‹è®¡ï¼Œä¸¤æœå¼€æµè€è‡£å¿ƒã€‚å‡ºå¸ˆæœªæ·èº«å…ˆæ­»ï¼Œé•¿ä½¿è‹±é›„æ³ªæ»¡è¥Ÿã€‚',
                        exercises: [
                            {
                                type: 'fillBack',
                                title: 'å†å²äººç‰©å¡«ç©º',
                                description: 'è¯·æ ¹æ®å‰åŠå¥å†…å®¹ï¼Œå¡«å†™ååŠå¥',
                                items: [
                                    { front: 'ä¸ç›¸ç¥ å ‚ä½•å¤„å¯»', back: 'é”¦å®˜åŸå¤–æŸæ£®æ£®', hint: 'ç¥ å ‚åœ¨å“ªé‡Œï¼Ÿ' },
                                    { front: 'ä¸‰é¡¾é¢‘çƒ¦å¤©ä¸‹è®¡', back: 'ä¸¤æœå¼€æµè€è‡£å¿ƒ', hint: 'è°ä¸‰é¡¾èŒ…åºï¼Ÿ' }
                                ]
                            }
                        ]
                    }
                ],
                'è®ºè¯­å¿…èƒŒ': [
                    {
                        title: 'å­¦è€Œæ—¶ä¹ ä¹‹',
                        author: 'ã€Šè®ºè¯­ã€‹',
                        content: 'å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ï¼Ÿæœ‰æœ‹è‡ªè¿œæ–¹æ¥ï¼Œä¸äº¦ä¹ä¹ï¼Ÿäººä¸çŸ¥è€Œä¸æ„ ï¼Œä¸äº¦å›å­ä¹ï¼Ÿ',
                        exercises: [
                            {
                                type: 'fillBack',
                                title: 'å­¦ä¹ æ€åº¦å¡«ç©º',
                                description: 'è¯·æ ¹æ®å‰åŠå¥å†…å®¹ï¼Œå¡«å†™ååŠå¥',
                                items: [
                                    { front: 'å­¦è€Œæ—¶ä¹ ä¹‹', back: 'ä¸äº¦è¯´ä¹', hint: 'å­¦ä¹ åæ€ä¹ˆæ ·ï¼Ÿ' },
                                    { front: 'æœ‰æœ‹è‡ªè¿œæ–¹æ¥', back: 'ä¸äº¦ä¹ä¹', hint: 'æœ‹å‹æ¥äº†æ€ä¹ˆæ ·ï¼Ÿ' },
                                    { front: 'äººä¸çŸ¥è€Œä¸æ„ ', back: 'ä¸äº¦å›å­ä¹', hint: 'ä¸ç”Ÿæ°”æ€ä¹ˆæ ·ï¼Ÿ' }
                                ]
                            }
                        ]
                    }
                ]
            };
            
            return testData[chapter] || [];
        }

        // æ˜¾ç¤ºè¯—æ–‡åˆ—è¡¨
        function displayPoemList() {
            const poemList = document.getElementById('poemList');
            poemList.innerHTML = '';
            
            poems.forEach((poem, index) => {
                const poemItem = document.createElement('div');
                poemItem.className = 'poem-item';
                poemItem.onclick = () => selectPoem(index);
                
                // æ˜¾ç¤ºç»ƒä¹ ç±»å‹æ•°é‡
                const exerciseCount = poem.exercises ? poem.exercises.length : 0;
                const exerciseText = exerciseCount > 0 ? `(${exerciseCount}ç§ç»ƒä¹ æ–¹å¼)` : '';
                
                poemItem.innerHTML = `
                    <h4>${poem.title}</h4>
                    <p>ä½œè€…ï¼š${poem.author}</p>
                    <p>${poem.content.substring(0, 50)}...</p>
                    <p class="exercise-count">${exerciseText}</p>
                `;
                
                poemList.appendChild(poemItem);
            });
        }

        // é€‰æ‹©è¯—æ–‡
        function selectPoem(index) {
            currentPoemIndex = index;
            const poem = poems[index];
            
            document.getElementById('poemSelection').style.display = 'none';
            document.getElementById('recitationPage').style.display = 'block';
            document.getElementById('poemTitle').textContent = poem.title;
            
            displayPoem(poem);
        }

        // æ˜¾ç¤ºè¯—æ–‡å†…å®¹
        function displayPoem(poem) {
            const poemText = document.getElementById('poemText');
            const blankText = document.getElementById('blankText');
            
            // é»˜å†™æ—¶ä¸æ˜¾ç¤ºå®Œæ•´è¯—æ–‡
            poemText.style.display = 'none';
            
            // åˆ›å»ºç»ƒä¹ é€‰æ‹©å™¨
            createExerciseSelector(poem);
            
            // æ¸…ç©ºå­¦ç”Ÿç­”æ¡ˆ
            document.getElementById('studentAnswer').value = '';
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.querySelector('.submit-btn').style.display = 'inline-block';
            document.querySelector('.show-answer-btn').style.display = 'none';
            document.querySelector('.next-btn').style.display = 'none';
            
            // æ¸…é™¤ä¹‹å‰çš„ç­”æ¡ˆæ˜¾ç¤º
            const answerComparison = document.querySelector('.answer-comparison');
            const correctAnswer = document.querySelector('.correct-answer');
            if (answerComparison) answerComparison.remove();
            if (correctAnswer) correctAnswer.remove();
        }

        // åˆ›å»ºç»ƒä¹ é€‰æ‹©å™¨
        function createExerciseSelector(poem) {
            const blankText = document.getElementById('blankText');
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©å™¨
            const existingSelector = document.querySelector('.exercise-selector');
            if (existingSelector) existingSelector.remove();
            
            blankText.innerHTML = '';
            
            if (!poem.exercises || poem.exercises.length === 0) {
                // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰ç»ƒä¹ ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å¼
                createDefaultExercise(poem);
                return;
            }
            
            // åˆ›å»ºç»ƒä¹ é€‰æ‹©å™¨
            const exerciseSelector = document.createElement('div');
            exerciseSelector.className = 'exercise-selector';
            
            let selectorHTML = '<h4>é€‰æ‹©ç»ƒä¹ æ–¹å¼ï¼š</h4><div class="exercise-options">';
            
            poem.exercises.forEach((exercise, index) => {
                selectorHTML += `
                    <div class="exercise-option" onclick="selectExercise(${index})">
                        <h5>${exercise.title}</h5>
                        <p>${exercise.description}</p>
                        <span class="exercise-type-badge">${getExerciseTypeName(exercise.type)}</span>
                    </div>
                `;
            });
            
            selectorHTML += '</div>';
            exerciseSelector.innerHTML = selectorHTML;
            
            blankText.appendChild(exerciseSelector);
        }

        // é€‰æ‹©ç»ƒä¹ 
        function selectExercise(exerciseIndex) {
            const poem = poems[currentPoemIndex];
            currentExerciseConfig = poem.exercises[exerciseIndex];
            
            // æ¸…é™¤é€‰æ‹©å™¨
            const selector = document.querySelector('.exercise-selector');
            if (selector) selector.remove();
            
            // ç”Ÿæˆç»ƒä¹ å†…å®¹
            generateCustomExercise();
        }

        // ç”Ÿæˆè‡ªå®šä¹‰ç»ƒä¹ 
        function generateCustomExercise() {
            const blankText = document.getElementById('blankText');
            const exercise = currentExerciseConfig;
            
            console.log('ç”Ÿæˆè‡ªå®šä¹‰ç»ƒä¹ ï¼š', exercise);
            
            // æ¸…é™¤ä¹‹å‰çš„ç»ƒä¹ å†…å®¹
            const existingExercise = document.querySelector('.exercise-content');
            if (existingExercise) existingExercise.remove();
            
            // åˆ›å»ºç»ƒä¹ å†…å®¹
            const exerciseContent = document.createElement('div');
            exerciseContent.className = 'exercise-content';
            
            let exerciseText = '';
            let allExercises = [];
            
            if (exercise.type === 'auto') {
                // è‡ªåŠ¨æ¨¡å¼ï¼šä½¿ç”¨é¢„å®šä¹‰çš„ç©ºç™½ä½ç½®
                const words = poems[currentPoemIndex].content.split('');
                exerciseText = words.map((char, index) => {
                    if (exercise.blanks.includes(index)) {
                        return '<span class="blank">_____</span>';
                    }
                    return char;
                }).join('');
                
                // æ”¶é›†æ‰€æœ‰ç­”æ¡ˆ
                allExercises = exercise.blanks.map(index => words[index]);
                
            } else if (exercise.type === 'fillFront' || exercise.type === 'fillBack') {
                // å¡«å‰å¥/å¡«åå¥æ¨¡å¼ï¼šä½¿ç”¨é¢„å®šä¹‰çš„ç»ƒä¹ é¡¹ç›®
                exerciseText = exercise.items.map((item, index) => {
                    if (exercise.type === 'fillFront') {
                        allExercises.push(item.front);
                        return `<div class="exercise-item">
                            <span class="exercise-number">${index + 1}.</span>
                            <span class="blank">_____</span>${item.back}
                            ${item.hint ? `<span class="hint">ğŸ’¡ ${item.hint}</span>` : ''}
                        </div>`;
                    } else {
                        allExercises.push(item.back);
                        return `<div class="exercise-item">
                            <span class="exercise-number">${index + 1}.</span>
                            ${item.front}<span class="blank">_____</span>
                            ${item.hint ? `<span class="hint">ğŸ’¡ ${item.hint}</span>` : ''}
                        </div>`;
                    }
                }).join('');
                
                // å°†ç»ƒä¹ é¡¹ç›®æŒ‰ä¸¤è¡Œä¸€ç»„è¿›è¡Œåˆ†ç»„
                const exerciseItems = exerciseText.match(/<div class="exercise-item">.*?<\/div>/g) || [];
                const groupedItems = [];
                
                for (let i = 0; i < exerciseItems.length; i += 2) {
                    const item1 = exerciseItems[i];
                    const item2 = exerciseItems[i + 1];
                    
                    let rowHtml = '<div class="exercise-row">';
                    
                    if (item1) {
                        rowHtml += `<div style="flex: 1; margin-right: 10px;">${item1}</div>`;
                    }
                    
                    if (item2) {
                        rowHtml += `<div style="flex: 1; margin-left: 10px;">${item2}</div>`;
                    }
                    
                    rowHtml += '</div>';
                    groupedItems.push(rowHtml);
                }
                
                exerciseText = groupedItems.join('');
            }
            
            exerciseContent.innerHTML = `
                <div class="exercise-instruction">
                    <h4>ç»ƒä¹ è¦æ±‚ï¼š</h4>
                    <p>${exercise.description}</p>
                </div>
                <div class="exercise-text">
                    ${exerciseText}
                </div>
                <div class="exercise-info">
                    <p>æ€»å…± ${allExercises.length} é“é¢˜ç›®ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­æŒ‰é¡ºåºå¡«å†™æ‰€æœ‰ç­”æ¡ˆï¼Œç”¨é€—å·åˆ†éš”</p>
                </div>
            `;
            
            blankText.appendChild(exerciseContent);
            
            // å­˜å‚¨æ‰€æœ‰ç­”æ¡ˆä¾›æäº¤æ—¶ä½¿ç”¨
            window.allExerciseAnswers = allExercises;
        }

        // åˆ›å»ºé»˜è®¤ç»ƒä¹ ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
        function createDefaultExercise(poem) {
            const blankText = document.getElementById('blankText');
            
            // æ·»åŠ ç»ƒä¹ ç±»å‹é€‰æ‹©
            const exerciseTypeSelector = document.createElement('div');
            exerciseTypeSelector.className = 'exercise-type-selector';
            exerciseTypeSelector.innerHTML = `
                <h4>é€‰æ‹©ç»ƒä¹ ç±»å‹ï¼š</h4>
                <div class="exercise-buttons">
                    <button class="exercise-btn" onclick="setExerciseType('auto')">è‡ªåŠ¨æ¨¡å¼</button>
                    <button class="exercise-btn" onclick="setExerciseType('fillFront')">å¡«å‰å¥</button>
                    <button class="exercise-btn" onclick="setExerciseType('fillBack')">å¡«åå¥</button>
                </div>
            `;
            
            blankText.appendChild(exerciseTypeSelector);
            
            // é»˜è®¤æ˜¾ç¤ºè‡ªåŠ¨æ¨¡å¼
            setExerciseType('auto');
        }

        // è·å–ç»ƒä¹ ç±»å‹åç§°
        function getExerciseTypeName(type) {
            const typeNames = {
                'auto': 'è‡ªåŠ¨æ¨¡å¼',
                'fillFront': 'å¡«å‰å¥',
                'fillBack': 'å¡«åå¥'
            };
            return typeNames[type] || type;
        }

        // è®¾ç½®ç»ƒä¹ ç±»å‹ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
        function setExerciseType(type) {
            currentExerciseType = type;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.exercise-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®å¹¶æ·»åŠ activeç±»
            const targetBtn = document.querySelector(`[onclick="setExerciseType('${type}')"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // ç”Ÿæˆå¯¹åº”çš„ç»ƒä¹ å†…å®¹
            generateExercise();
        }

        // ç”Ÿæˆç»ƒä¹ å†…å®¹ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
        function generateExercise() {
            const poem = poems[currentPoemIndex];
            const blankText = document.getElementById('blankText');
            
            console.log('ç”Ÿæˆç»ƒä¹ ï¼Œè¯—æ–‡ï¼š', poem.title);
            console.log('ç»ƒä¹ ç±»å‹ï¼š', currentExerciseType);
            console.log('è¯—æ–‡å†…å®¹ï¼š', poem.content);
            
            // è·å–é€‰æ‹©å™¨
            const selector = document.querySelector('.exercise-type-selector');
            
            // æ¸…é™¤ä¹‹å‰çš„ç»ƒä¹ å†…å®¹
            const existingExercise = document.querySelector('.exercise-content');
            if (existingExercise) existingExercise.remove();
            
            // åˆ›å»ºç»ƒä¹ å†…å®¹
            const exerciseContent = document.createElement('div');
            exerciseContent.className = 'exercise-content';
            
            let exerciseText = '';
            let allExercises = [];
            
            if (currentExerciseType === 'auto') {
                // è‡ªåŠ¨æ¨¡å¼ï¼šéšæœºé€‰æ‹©ä¸€äº›å­—è¯ä½œä¸ºç©ºç™½
                const words = poem.content.split('');
                const blankIndices = poem.blanks || [];
                
                exerciseText = words.map((char, index) => {
                    if (blankIndices.includes(index)) {
                        return '<span class="blank">_____</span>';
                    }
                    return char;
                }).join('');
                
                // æ”¶é›†æ‰€æœ‰ç­”æ¡ˆ
                allExercises = blankIndices.map(index => words[index]);
                
            } else if (currentExerciseType === 'fillFront') {
                // å¡«å‰å¥æ¨¡å¼ï¼šæ˜¾ç¤ºååŠå¥ï¼Œè¦æ±‚å¡«å†™å‰åŠå¥
                const sentences = splitByPunctuation(poem.content);
                console.log('å¡«å‰å¥æ¨¡å¼ï¼Œåˆ†å‰²åçš„å¥å­ï¼š', sentences);
                
                exerciseText = sentences.map((sentence, index) => {
                    if (!sentence.trim()) return '';
                    
                    // å¯»æ‰¾åˆé€‚çš„åˆ†å‰²ç‚¹ï¼ˆä¼˜å…ˆåœ¨é€—å·ã€é¡¿å·ç­‰æ ‡ç‚¹å¤„åˆ†å‰²ï¼‰
                    const splitPoint = findNaturalSplitPoint(sentence);
                    const frontPart = sentence.substring(0, splitPoint);
                    const backPart = sentence.substring(splitPoint);
                    
                    console.log(`å¥å­${index + 1}: "${sentence}" -> å‰åŠ: "${frontPart}", ååŠ: "${backPart}"`);
                    
                    allExercises.push(frontPart);
                    
                    return `<div class="exercise-item">
                        <span class="exercise-number">${index + 1}.</span>
                        <span class="blank">_____</span>${backPart}
                    </div>`;
                }).filter(item => item !== '').join('');
                
            } else if (currentExerciseType === 'fillBack') {
                // å¡«åå¥æ¨¡å¼ï¼šæ˜¾ç¤ºå‰åŠå¥ï¼Œè¦æ±‚å¡«å†™ååŠå¥
                const sentences = splitByPunctuation(poem.content);
                console.log('å¡«åå¥æ¨¡å¼ï¼Œåˆ†å‰²åçš„å¥å­ï¼š', sentences);
                
                exerciseText = sentences.map((sentence, index) => {
                    if (!sentence.trim()) return '';
                    
                    // å¯»æ‰¾åˆé€‚çš„åˆ†å‰²ç‚¹ï¼ˆä¼˜å…ˆåœ¨é€—å·ã€é¡¿å·ç­‰æ ‡ç‚¹å¤„åˆ†å‰²ï¼‰
                    const splitPoint = findNaturalSplitPoint(sentence);
                    const frontPart = sentence.substring(0, splitPoint);
                    const backPart = sentence.substring(splitPoint);
                    
                    console.log(`å¥å­${index + 1}: "${sentence}" -> å‰åŠ: "${frontPart}", ååŠ: "${backPart}"`);
                    
                    allExercises.push(backPart);
                    
                    return `<div class="exercise-item">
                        <span class="exercise-number">${index + 1}.</span>
                        ${frontPart}<span class="blank">_____</span>
                    </div>`;
                }).filter(item => item !== '').join('');
            }
            
            console.log('ç”Ÿæˆçš„ç»ƒä¹ HTMLï¼š', exerciseText);
            console.log('æ”¶é›†çš„ç­”æ¡ˆï¼š', allExercises);
            
            // å°†ç»ƒä¹ é¡¹ç›®æŒ‰ä¸¤è¡Œä¸€ç»„è¿›è¡Œåˆ†ç»„ï¼Œå®ç°"ä¸¤å¥è¯ä¸€è¡Œ"çš„æ˜¾ç¤ºæ•ˆæœ
            if (currentExerciseType !== 'auto') {
                const exerciseItems = exerciseText.match(/<div class="exercise-item">.*?<\/div>/g) || [];
                console.log('åŒ¹é…åˆ°çš„ç»ƒä¹ é¡¹ç›®ï¼š', exerciseItems);
                
                const groupedItems = [];
                
                for (let i = 0; i < exerciseItems.length; i += 2) {
                    const item1 = exerciseItems[i];
                    const item2 = exerciseItems[i + 1];
                    
                    let rowHtml = '<div class="exercise-row">';
                    
                    if (item1) {
                        rowHtml += `<div style="flex: 1; margin-right: 10px;">${item1}</div>`;
                    }
                    
                    if (item2) {
                        rowHtml += `<div style="flex: 1; margin-left: 10px;">${item2}</div>`;
                    }
                    
                    rowHtml += '</div>';
                    groupedItems.push(rowHtml);
                }
                
                exerciseText = groupedItems.join('');
                console.log('åˆ†ç»„åçš„HTMLï¼š', exerciseText);
            }
            
            exerciseContent.innerHTML = `
                <div class="exercise-instruction">
                    <h4>ç»ƒä¹ è¦æ±‚ï¼š</h4>
                    <p>${getExerciseInstruction()}</p>
                </div>
                <div class="exercise-text">
                    ${currentExerciseType === 'auto' ? exerciseText : exerciseText}
                </div>
                <div class="exercise-info">
                    <p>æ€»å…± ${allExercises.length} é“é¢˜ç›®ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­æŒ‰é¡ºåºå¡«å†™æ‰€æœ‰ç­”æ¡ˆï¼Œç”¨é€—å·åˆ†éš”</p>
                </div>
            `;
            
            blankText.appendChild(exerciseContent);
            
            // å­˜å‚¨æ‰€æœ‰ç­”æ¡ˆä¾›æäº¤æ—¶ä½¿ç”¨
            window.allExerciseAnswers = allExercises;
        }

        // è·å–ç»ƒä¹ è¯´æ˜
        function getExerciseInstruction() {
            switch (currentExerciseType) {
                case 'auto':
                    return 'è¯·å¡«å†™ä¸‹åˆ’çº¿å¤„çš„å­—è¯';
                case 'fillFront':
                    return 'è¯·æ ¹æ®ååŠå¥å†…å®¹ï¼Œå¡«å†™å‰åŠå¥';
                case 'fillBack':
                    return 'è¯·æ ¹æ®å‰åŠå¥å†…å®¹ï¼Œå¡«å†™ååŠå¥';
                default:
                    return 'è¯·å®Œæˆç»ƒä¹ ';
            }
        }

        // æäº¤ç­”æ¡ˆ
        function submitAnswer() {
            const studentAnswer = document.getElementById('studentAnswer').value.trim();
            if (!studentAnswer) {
                alert('è¯·è¾“å…¥ä½ çš„é»˜å†™å†…å®¹ï¼');
                return;
            }
            
            const poem = poems[currentPoemIndex];
            const allAnswers = window.allExerciseAnswers || [];
            
            if (allAnswers.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°ç»ƒä¹ é¢˜ç›®ï¼');
                return;
            }
            
            // è§£æå­¦ç”Ÿç­”æ¡ˆï¼ˆæŒ‰é€—å·åˆ†éš”ï¼‰
            let studentAnswers = [];
            if (currentExerciseType === 'auto') {
                // è‡ªåŠ¨æ¨¡å¼ï¼šå­¦ç”Ÿå¯èƒ½è¾“å…¥è¿ç»­çš„å­—ç¬¦
                studentAnswers = studentAnswer.split('');
            } else {
                // å¡«å‰å¥/å¡«åå¥æ¨¡å¼ï¼šæŒ‰é€—å·åˆ†éš”
                studentAnswers = studentAnswer.split('ï¼Œ').map(s => s.trim()).filter(s => s);
            }
            
            // ç¡®ä¿ç­”æ¡ˆæ•°é‡åŒ¹é…
            if (studentAnswers.length !== allAnswers.length) {
                alert(`è¯·è¾“å…¥ ${allAnswers.length} ä¸ªç­”æ¡ˆï¼Œå½“å‰è¾“å…¥äº† ${studentAnswers.length} ä¸ª`);
                return;
            }
            
            // åˆ›å»ºè¯¦ç»†çš„ç­”æ¡ˆå¯¹æ¯”
            const answerComparison = document.createElement('div');
            answerComparison.className = 'answer-comparison';
            
            let comparisonHTML = '<h4>ç­”æ¡ˆå¯¹æ¯”</h4>';
            
            // ä¸ºæ¯ä¸ªé¢˜ç›®åˆ›å»ºå¯¹æ¯”è¡Œ
            for (let i = 0; i < allAnswers.length; i++) {
                const isCorrect = studentAnswers[i] === allAnswers[i];
                const statusIcon = isCorrect ? 'âœ…' : 'âŒ';
                const statusClass = isCorrect ? 'correct' : 'incorrect';
                
                comparisonHTML += `
                    <div class="answer-row ${statusClass}">
                        <span class="answer-label">ç¬¬${i + 1}é¢˜ï¼š</span>
                        <div class="answer-content">
                            <span class="student-answer">ä½ çš„ç­”æ¡ˆï¼š${studentAnswers[i] || 'æœªå¡«å†™'}</span>
                            <span class="correct-answer">æ­£ç¡®ç­”æ¡ˆï¼š${allAnswers[i]}</span>
                            <span class="status-icon">${statusIcon}</span>
                        </div>
                    </div>
                `;
            }
            
            // è®¡ç®—æ­£ç¡®ç‡
            const correctCount = studentAnswers.filter((answer, index) => answer === allAnswers[index]).length;
            const accuracy = Math.round((correctCount / allAnswers.length) * 100);
            
            comparisonHTML += `
                <div class="answer-summary">
                    <h5>ç»ƒä¹ æ€»ç»“</h5>
                    <p>æ­£ç¡®ï¼š${correctCount} é¢˜ï¼Œé”™è¯¯ï¼š${allAnswers.length - correctCount} é¢˜</p>
                    <p>æ­£ç¡®ç‡ï¼š${accuracy}%</p>
                    <p class="feedback">${accuracy >= 80 ? 'ğŸ‰ ä¼˜ç§€ï¼ç»§ç»­ä¿æŒï¼' : accuracy >= 60 ? 'ğŸ‘ ä¸é”™ï¼ç»§ç»­åŠªåŠ›ï¼' : 'ğŸ’ª åŠ æ²¹ï¼å¤šç»ƒä¹ å‡ æ¬¡ï¼'}</p>
                </div>
            `;
            
            answerComparison.innerHTML = comparisonHTML;
            
            // æ’å…¥åˆ°è¾“å…¥åŒºåŸŸåé¢
            const inputArea = document.querySelector('.input-area');
            inputArea.parentNode.insertBefore(answerComparison, inputArea.nextSibling);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelector('.submit-btn').style.display = 'none';
            document.querySelector('.show-answer-btn').style.display = 'inline-block';
            document.querySelector('.next-btn').style.display = 'inline-block';
        }

        // æ˜¾ç¤ºç­”æ¡ˆ
        function showAnswer() {
            const poem = poems[currentPoemIndex];
            const correctAnswer = document.createElement('div');
            correctAnswer.className = 'correct-answer';
            correctAnswer.innerHTML = `
                <h4>å®Œæ•´è¯—æ–‡</h4>
                <p>${poem.content}</p>
            `;
            
            // æ’å…¥åˆ°ç­”æ¡ˆå¯¹æ¯”åé¢
            const answerComparison = document.querySelector('.answer-comparison');
            if (answerComparison) {
                answerComparison.parentNode.insertBefore(correctAnswer, answerComparison.nextSibling);
            }
        }

        // ä¸‹ä¸€ç¯‡è¯—æ–‡
        function nextPoem() {
            if (currentPoemIndex < poems.length - 1) {
                currentPoemIndex++;
                const poem = poems[currentPoemIndex];
                
                // æ¸…é™¤ä¹‹å‰çš„ç­”æ¡ˆæ˜¾ç¤º
                const answerComparison = document.querySelector('.answer-comparison');
                const correctAnswer = document.querySelector('.correct-answer');
                if (answerComparison) answerComparison.remove();
                if (correctAnswer) correctAnswer.remove();
                
                displayPoem(poem);
            } else {
                alert('å·²ç»æ˜¯æœ€åä¸€ç¯‡è¯—æ–‡äº†ï¼');
            }
        }

        // æ™ºèƒ½åˆ†å‰²å¥å­ï¼Œä¼˜å…ˆåœ¨æ ‡ç‚¹ç¬¦å·å¤„åˆ†å‰²
        function splitByPunctuation(text) {
            console.log('å¼€å§‹åˆ†å‰²æ–‡æœ¬ï¼š', text);
            
            // å¦‚æœæ–‡æœ¬æ²¡æœ‰å¥å·ï¼Œç›´æ¥æŒ‰é€—å·åˆ†å‰²
            if (!text.includes('ã€‚')) {
                console.log('æ–‡æœ¬æ²¡æœ‰å¥å·ï¼Œç›´æ¥æŒ‰é€—å·åˆ†å‰²');
                const parts = text.split(/[ï¼Œã€]/).filter(part => part.trim());
                console.log('æŒ‰é€—å·åˆ†å‰²ç»“æœï¼š', parts);
                return parts;
            }
            
            // æŒ‰å¥å·åˆ†å‰²ï¼Œä½†ä¿ç•™æ ‡ç‚¹ç¬¦å·
            const sentences = text.split('ã€‚').filter(s => s.trim());
            console.log('æŒ‰å¥å·åˆ†å‰²ç»“æœï¼š', sentences);
            
            // è¿›ä¸€æ­¥å¤„ç†æ¯ä¸ªå¥å­ï¼Œåœ¨é€—å·ã€é¡¿å·ç­‰æ ‡ç‚¹å¤„åˆ†å‰²
            const result = [];
            sentences.forEach((sentence, index) => {
                if (!sentence.trim()) return;
                
                if (sentence.includes('ï¼Œ') || sentence.includes('ã€')) {
                    // å¦‚æœå¥å­åŒ…å«é€—å·æˆ–é¡¿å·ï¼ŒæŒ‰è¿™äº›æ ‡ç‚¹åˆ†å‰²
                    const parts = sentence.split(/[ï¼Œã€]/);
                    parts.forEach(part => {
                        if (part.trim()) {
                            result.push(part.trim());
                        }
                    });
                } else {
                    result.push(sentence.trim());
                }
            });
            
            console.log('æœ€ç»ˆåˆ†å‰²ç»“æœï¼š', result);
            return result;
        }

        // å¯»æ‰¾è‡ªç„¶çš„åˆ†å‰²ç‚¹
        function findNaturalSplitPoint(sentence) {
            // ä¼˜å…ˆåœ¨é€—å·ã€é¡¿å·å¤„åˆ†å‰²
            const commaIndex = sentence.indexOf('ï¼Œ');
            const pauseIndex = sentence.indexOf('ã€');
            
            if (commaIndex !== -1) {
                return commaIndex + 1; // åŒ…å«é€—å·
            } else if (pauseIndex !== -1) {
                return pauseIndex + 1; // åŒ…å«é¡¿å·
            } else {
                // å¦‚æœæ²¡æœ‰æ ‡ç‚¹ï¼Œåˆ™åœ¨å¥å­ä¸­é—´åˆ†å‰²
                return Math.floor(sentence.length / 2);
            }
        }
    </script>
</body>
</html>
